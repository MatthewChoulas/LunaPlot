<!DOCTYPE html>
<html>
    <head>
        <title>Arduino Web Plotter</title>
        <link rel="stylesheet" href="style.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.2/socket.io.js" integrity="sha512-VJ6+sp2E5rFQk05caiXXzQd1wBABpjEj1r5kMiLmGAAgwPItw1YpqsCCBtq8Yr1x6C49/mTpRdXtq8O2RcZhlQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    </head>

    <body>
        <div class="navbar"><span>Arduino Web Plotter</span></div>
        <div id="sample"></div>
        <div class = "wrapper">
            <div id="chart"></div>
        </div>


        <script>
            const graphDiv = document.getElementById('chart');
            const start = Date.now();
            var first = true;

            const xrange = 5000;
            var xmin = 0;
            var xmax = xrange;

            var traces = [];

            var placeHolderData = [{
                x: [0],
                y: [0],
                type: 'scatter'
            }];

            

            Plotly.newPlot(graphDiv, placeHolderData);


            var socket = io();

            socket.on('data', function(data){
                document.getElementById('sample').innerHTML = data;
                plotData(data);
            });




            function plotData(data) {
                
                var value = parseInt(data.slice(6), 10);
                var time = Date.now() - start;


                
                data = data.split(" ");
                data = data.map((element,index) => {
                    element = element.split(":");
                    element[1] = parseInt(element[1]);
                    return element;
                });
                
               
                
                if (first && data.length > 0) {
                    first = false;
                    console.log("first");
                    var name = data[0][0]
                    Plotly.addTraces(graphDiv, [{x: [0], y: [0], name: name, type:"line"}]);
                    traces.push(name)
                    Plotly.deleteTraces(graphDiv, 0);
                }
 
                for (let i in data) {
                    var trace = data[i];
                    if (traces.includes(trace[0]) == false) {
                        traces.push(trace[0]);
                        Plotly.addTraces('chart', [{x: [0], y: [0], name: trace[0], type:"line"}]);
                    }
                }
                
                xValues = Array(data.length).fill([time]);
                yValues = data.map((trace) => {
                    return [trace[1]];
                });
                traceIndexes = Array(data.length).fill(0).map((x, y) => x + y);
                console.log(yValues);

                Plotly.extendTraces('chart', {
                    x:xValues, 
                    y:yValues
                }, traceIndexes, 500);
                


                
                 
                if (time > xmax) {
                    xmax += 10*(time-xmax);
                    xmin = xmax-xrange;
                    
                    Plotly.relayout('chart', {
                        xaxis: {
                            range: [xmin, xmax]
                        }
                    })
                }
                
                
                
            }
        </script>
    </body>
</html>